<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Test</title>
</head>
<body>
    <h1>WebAssembly Function Test</h1>
    <div id="status">Loading...</div>
    <script src="static/wasm_exec.js"></script>
    <script>
        async function test() {
            const go = new Go();
            
            try {
                const response = await fetch('static/imagekit.wasm');
                const buffer = await response.arrayBuffer();
                const result = await WebAssembly.instantiate(buffer, go.importObject);
                go.run(result.instance);
                
                // Wait for Go to initialize
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Check available functions
                const funcs = ['resizeImage', 'cropImage', 'convertDPI', 'processImage'];
                let html = '<h2>Function Check:</h2><ul>';
                
                for (const func of funcs) {
                    const exists = typeof window[func] === 'function';
                    html += `<li>${func}: ${exists ? '✅' : '❌'}</li>`;
                }
                
                html += '</ul>';
                
                // Test processImage with dummy data
                if (typeof window.processImage === 'function') {
                    html += '<h2>Testing processImage:</h2>';
                    
                    // Test 1: Simple pass-through (no processing)
                    try {
                        const testData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                        const options = {
                            resize: false,
                            crop: false,
                            dpi: false,
                            width: 0,
                            height: 0,
                            cropTop: '0',
                            cropRight: '0',
                            cropBottom: '0',
                            cropLeft: '0'
                        };
                        
                        console.log('Test data:', testData);
                        console.log('Test options:', options);
                        
                        const result = window.processImage(testData, options);
                        html += '<h3>Test 1 (no processing):</h3>';
                        html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                        
                        if (result.success && result.data) {
                            html += `<img src="${result.data}" style="border: 1px solid black; margin: 10px;">`;
                        }
                    } catch (error) {
                        html += `<p style="color: red;">Test 1 Error: ${error.message}</p>`;
                    }
                    
                    // Test 2: With resize
                    try {
                        const testData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                        const options = {
                            resize: true,
                            crop: false,
                            dpi: false,
                            width: 10,
                            height: 10,
                            cropTop: '0',
                            cropRight: '0',
                            cropBottom: '0',
                            cropLeft: '0'
                        };
                        
                        const result = window.processImage(testData, options);
                        html += '<h3>Test 2 (resize to 10x10):</h3>';
                        html += `<pre>${JSON.stringify({success: result.success, error: result.error}, null, 2)}</pre>`;
                        
                        if (result.success && result.data) {
                            html += `<img src="${result.data}" style="border: 1px solid black; margin: 10px; width: 50px; height: 50px;">`;
                        }
                    } catch (error) {
                        html += `<p style="color: red;">Test 2 Error: ${error.message}</p>`;
                    }
                }
                
                document.getElementById('status').innerHTML = html;
            } catch (error) {
                document.getElementById('status').innerHTML = `<p style="color: red;">Failed: ${error.message}</p>`;
            }
        }
        
        test();
    </script>
</body>
</html>